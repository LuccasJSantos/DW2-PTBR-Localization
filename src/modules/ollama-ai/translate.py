from meta_ai_api import MetaAI
from xml.etree import ElementTree as ET
import util
import time
import ollama

translation_prompt = "Traduza o seguinte texto para Português do Brasil. O Contexto é Sci-Fi espacial"
translation_components = "Canhão Laser [P],Projetor de Campo de Íons [P],Bomba de Onda [M],Projetor de Fluxo de Gravitons [G],Torpedo de Plasma [P],Míssil Seeker [P],Canhão de Longo Alcance [P],Canhão Laser [Ftr],Blaster Repetidor Buckler [DP],Feixe Thuon [M],Blaster Maxos [P],Canhão de Íons [P],Bomba de Íons [G],Explosão Intimidator [G],Feixe de Gravitons [G],Torpedo Épsilon [P],Míssil Interceptador [DP],Míssil de Concussão [P],Devastador Atômico [G],Canhão de Defesa de Ponto [DP],Canhão Eletromagnético [P],Blaster de Pulso de Íons [DP],Escudo de Íons,Feixe de Trator [M],Torpedo Tempestade de Fogo [Ftr],Míssil Relâmpago [M],Míssil Balístico [G],Canhão Eletromagnético Pesado [G],Defesa Multi-Feixe Sentinel [DP],Feixe Shatterforce [M],Bateria de Mísseis Bulwark [DP],Blaster de Assalto de Impacto [P],Pulso de Íons [G],Onda de Choque Derasiana [G],Torpedo de Onda de Choque [M],Fragmento de Velocidade [P],Exterminador de Nêutrons [G],Condutor de Massa Eclipse [G],Bateria de Defesa de Ponto Ligada [DP],Lança Phaser [G],Lança Eletromagnética [G],Minas de Choque Aniquilador [G],Feixe de Gravitons Ressonante [P],Feixe de Trator de Longo Alcance [P],Feixe de Trator de Alta Potência [P],Canhão Granizo [Ftr],Minas Graviticas Riptide [G],Pulso de Gravitons [G],Raio de Plasma [P],Míssil Nova [G],Bateria de Mísseis Bulwark [P],Bateria de Mísseis Aegis [DP],Bateria de Mísseis Colmeia [P],Bateria de Mísseis Caçador [G],Bateria de Autocanhões Terminator [DP],Bateria de Trilho Forge [G],Blaster Titã [P],Matriz de Pulso Rápido de Íons [DP],Canhão de Íons Pesado [G],Torpedo Épsilon [M],Grade de Defesa Guardião [DP],Matriz de Feixes Fásicos [Ftr],Onda de Pulso Nova [G],Fragmento Quântico [Ftr],Feixe Ômega [G],Propulsor de Salto,Singularidade Transitória [G],Feixe de Controle Gravitico [P],Gerador de Poço Gravitacional,Mísseis Enxame Reforçados [Ftr],Exterminador Continental [G],Raio da Morte [X],Blaster Solar [X],Explosão Quântica [X],Projetor de Buraco Negro [X],Torpedo Supernova [X],Bateria de Enxame Replicante [X],Exterminador Planetário [X],Sistema de Rastreamento de Alvos,Sistema de Contramedidas,Matriz de Sensores de Proximidade,Módulo de Pesquisa Básico,Compartimento Básico de Tropas,Compartimento Básico de Passageiros,Baía de Carga Básica,Célula de Combustível Básica,Baía de Atracação,Centro de Comércio,Sistemas de Tripulação Básicos,Centro Médico Básico,Centro de Recreação Básico,Laboratório de Pesquisa Básico,Centro de Comando Básico,Sensores Multitrava,ECM ShadowGhost,Scanner de Rastreamento,Matriz de Sensores de Curto Alcance,Scanner de Recursos,Módulo de Pesquisa Avançado,Módulo de Colonização,Compartimento de Tropas,Compartimento de Passageiros,Baía de Carga,Célula de Combustível,Célula de Combustível de Mega-Densidade,Centro Médico,Centro de Recreação,Laboratório de Pesquisa,Centro de Comando,Jammer de Rastreamento,Sistema de Alvo da Frota,Sistema de Contramedidas da Frota,Manto de Furtividade,Matriz de Sensores de Longo Alcance,Compartimento Grande de Tropas,Compartimento Grande de Passageiros,Grande Baía de Carga,Grande Célula de Combustível,Motor de Mineração Pequeno,Sistema Avançado de Rastreamento de Alvos,Sistema Avançado de Contramedidas,Scanner de Rastreamento Multi-Espectro,Matriz de Sensores de Ultra Longo Alcance,Invólucro de Furtividade I-Space,Jammer de Rastreamento Multi-Espectro,Scanner Planetário Profundo,Módulo de Pesquisa Profunda,Compartimento Massivo de Tropas,Compartimento Massivo de Passageiros,Baía de Carga Massiva,Célula de Combustível de Alta Densidade,Centro Médico Avançado,Centro de Recreação Avançado,Sistema de Combate Omni-Lock,Gerador de Túnel I-Space,Sensores do Vazio,Reator Espacial Básico,Gerador de Campo de Deflexão,Gerador de Bolha de Dobra,Motor de Íons,Propulsor Direcional,Motor de Mineração Grande,Baía Média de Caça Estelar,Grande Baía de Caça Estelar,Coletor de Energia,Undefined,Reator de Fissão,Motor de Prótons,Feixe Ômega [P],Cápsula de Assalto,Armadura Padrão,Unidade de Controle de Danos,Feixe Ômega [M],Gerador de Campo de Bloqueio [DP],Escudos Corvidianos,Hiperdrive Gerax,Motor TurboThruster,Motor Quântico,Motor Acceleros,Motor StarBurner,Canhão de Ondas Eletromagnéticas [G],Torpedo Tempestade de Fogo [G],Bateria de Trilho Forge [M],Reator de Fusão,Reator Quântico,Feixe Ômega [Ftr],Escudos Talassos,Escudos Deucalios,HyperDeny GW1000,Hiperdrive Kaldos,Hiperdrive Calista-Dal,Hiperdrive Equinox,Motor Vetor,Armadura Melhorada,Undefined,Baía Pequena de Caça Estelar,Robôs de Reparação SF24,Reator de Hiperfusão,Gerador de Escudo de Ponto [DP],HyperDeny GW4000,Reator de Hiperfusão [Ftr],Canhão de Íons Pesado [M],Armadura Reativa,Escudos Meridianos,Bateria de Mísseis Colmeia [M],Recarga de Escudo de Área,Armadura Ultra-Densa,Reator de Ponto Zero,Armadura Absorvente,Conversor de Energia para Combustível,Reator Estrela Negra,Escudos Citadel,Mísseis Colmeia [Ftr],Bateria de Mísseis Caçador [M],Matriz de Feixes Fásicos [G],Armadura Estelar,Estaleiro de Construção,Míssil Seeker [Ftr],Torpedo Épsilon [Ftr],Canhão de Longo Alcance [Ftr],Blaster Maxos [Ftr],Míssil de Concussão [Ftr],Canhão Eletromagnético [Ftr],Míssil de Concussão [M],Canhão Eletromagnético [M],Armadura de Bainha de Íons,Armadura Endurecida por Íons,Armadura Padrão [Ftr],Armadura Melhorada [Ftr],Armadura Reativa [Ftr],Gerador de Campo de Deflexão [Ftr],Escudos Corvidianos [Ftr],Motor de Íons [Ftr],Motor de Prótons [Ftr],Reator Espacial Básico [Ftr],Reator de Fissão [Ftr],Reator de Fusão [Ftr],Célula de Combustível [Ftr],Vetor de Empuxo,Blaster de Pulso de Íons [Ftr],Feixe de Gravitons [Ftr],Feixe Thuon [G],Blaster Maxos [M],Feixe de Gravitons [M],Canhão de Íons [M],Blaster de Assalto de Impacto [M],Canhão Phaser [P],Feixe Shatterforce [G],Míssil de Concussão [G],Fragmento de Velocidade [M],Míssil Relâmpago [P],Míssil Relâmpago [Ftr],Canhão Phaser [Ftr],Blaster de Assalto de Impacto [Ftr],Míssil Balístico [M],Torpedo Tempestade de Fogo [P],Torpedo Tempestade de Fogo [M],Módulo de Comando Básico [Ftr],Blaster de Pulso Rápido de Íons [Ftr],Feixe Dealbreaker [G],Sistemas de Tripulação,Gerador de Campo Estelar,Bateria de Mísseis Planetária,Bateria de Canhão Planetária,Feixe Estelar [Ftr],Blaster de Plasma [Ftr],Feixe Estelar [P],Blaster de Plasma [P],Canhão de Onda de Pulso [P],Feixe Estelar [M],Blaster de Plasma [M],Canhão de Onda de Pulso [M],Undefined,Torpedo de Pulso [G],Undefined,Feixe Estelar [G],Undefined,Matriz de Feixes Fásicos [P],Torpedo de Pulso [M],Undefined,Matriz de Feixes Fásicos [M],Armadura Endurecida por Fluxo,Armadura de Bainha de Fluxo,Armadura de Barreira de Fluxo,Armadura Endurecida por Fluxo [Ftr],Armadura de Bainha de Fluxo [Ftr],Armadura de Bainha de Íons [Ftr],Armadura Ultra-Densa [Ftr],Armadura de Barreira de Fluxo [Ftr],Armadura Endurecida por Íons [Ftr],Armadura Absorvente [Ftr],Armadura Estelar [Ftr],Escudos Megatron Z4,Capacitores Quânticos,Escudos Megatron Z4 [Ftr],Escudos Talassos [Ftr],Escudos Deucalios [Ftr],Escudos Meridianos [Ftr],Escudos Citadel [Ftr],Motor Vórtice,Propulsor de Fluxo Infinito,Motor Quântico [Ftr],Motor Acceleros [Ftr],Motor TurboThruster [Ftr],Motor StarBurner [Ftr],Motor Vetor [Ftr],Motor Vórtice [Ftr],Propulsor de Fluxo Infinito [Ftr],Vetor Único,Vetor Múltiplo,Vetor Rápido,Vetor Omni,Propulsor Inercial,Feixe Dealbreaker [M],Feixe de Gravitons Ressonante [Ftr],Fragmento de Velocidade [Ftr],Torpedo de Pulso [Ftr],Torpedo de Onda de Choque [G],Canhão Granizo [P],Canhão Phaser [M],Feixe de Gravitons Ressonante [M],Canhão Eletromagnético Pesado [M],Undefined,Reator Quântico [Ftr],Reator de Ponto Zero [Ftr],Reator Estrela Negra [Ftr],Propulsor de Torrente,Propulsor de Buraco de Minhoca,Sensores de Cristal,Undefined,Centro de Comando Integrado,Centro de Comando Avançado,Módulo de Comando [Ftr],Feixe de Grapple [P],Rede Gravitica Planetária,Feixe Cristalino (Anã Branca),Feixe Cristalino (Sequência Principal),Feixe Cristalino (Gigante Vermelha),Feixe Cristalino (Gigante Azul),Feixe Cristalino (Super Gigante),Feixe Cristalino (Nêutron),Feixe Cristalino (Buraco Negro),Pulso Gravion de Lesma Espacial,Arco Relâmpago Ardilus,Bateria de Defesa Planetária,Defesa de Feixe Planetária,Canhão de Íons Gigante Planetário,Projetores de Minas Planetárias,Lançador de Torpedos Planetário,Raio de Plasma [G],Raio de Plasma [M],Fragmento Quântico [G],Fragmento Quântico [P],Fragmento Quântico [M],Canhão de Íons Rápido [P],Bateria de Enxame Reforçada [G],Bateria de Enxame Reforçada [P],Bateria de Enxame Reforçada [M],Autocanhão Terminator [Ftr],Blaster Titã [M],Blaster Titã [Ftr],Feixe Dealbreaker [P],Torpedo de Pulso [P],Coletor de Energia Aumentado,Quartel de Fuzileiros Estelares,Observatório de Espaço Profundo,Transferência Remota de Combustível,Propulsor de Enxame,Motor de Enxame,Motor de Enxame [Ftr],Armadura Pesada,Armadura Pesada [Ftr],Feixe de Partículas [P],Feixe de Partículas [M],Feixe Thuon [P],Feixe Shatterforce [P],Feixe de Gravitons Ressonante [G],Blaster de Assalto de Impacto [G],Canhão Phaser [G],Blaster Titã [G],Lança Phaser [M],Feixe de Partículas [Ftr],Feixe Thuon [Ftr],Feixe Shatterforce [Ftr],Célula de Combustível Básica [Ftr],Célula de Combustível de Mega-Densidade [Ftr],Grande Célula de Combustível [Ftr],Célula de Combustível de Alta Densidade [Ftr],Super Laser [X],Pulso Devastador [X],Undefined,Undefined,Undefined,Undefined,Undefined,Undefined,Undefined,Undefined,Undefined,Undefined,Undefined,Undefined,Canhão Granizo [M],Armadura de Bloco,Armadura de Bloco Reativa,Armadura de Bloco Densa,Armadura de Bloco [Ftr],Armadura de Bloco Reativa [Ftr],Armadura de Bloco Densa [Ftr]"

def translate(source_path: str, target_path: str, xpath: str, context: str = ""):
    start_time = time.time()

    root = ET.parse(source_path)
    items = root.findall(xpath)

    util.create_empty_file(target_path)

    print(f"Translating {source_path.split("/")[-1]} ({xpath.split("/")[-1]}s)")

    print(f"0/{len(items)} {xpath.split("/")[-1]}s translated", end="\r")

    if len(items) == 0:
        print("")
        root.write(target_path, encoding="utf-8", xml_declaration=True)
        print("")
        return

    for i, it in enumerate(items):
        if it.text == None:
            print("No text to translate")
            print("")
            break

        response = ollama.chat(
            model='mistral-nemo',
            messages=[
                { 'role': 'system', 'content': "Você é um tradutor profissional, especializado em tradução de jogos sci-fi espacial." },
                { 'role': 'system', 'content': "Não elabore o texto, apenas traduza diretamente, sem acrescentar nem remover."},
                { 'role': 'system', 'content': "Não retorne no texto de sua resposta 'Nota:' sobre a sua tradução. Retorne apenas o texto traduzido." },
                { 'role': 'system', 'content': "Não traduza textos entre colchetes e nem textos entre chaves, mantenha-os na mesma estrutura, pois são variáveis usadas internamente no código do jogo." },
                { 'role': 'system', 'content': f"Contexto da tradução é {context}"},
                { 'role': 'user', 'content': f"""{translation_prompt}. Texto para traduzir:
                 {it.text}""" }
            ]
        )
        print(f"{i + 1}/{len(items)} {xpath.split("/")[-1]}s translated", end="\r")
        it.text = response.get("message").get("content")

    root.write(target_path, encoding="utf-8", xml_declaration=True)
    print("")
    print(f"Finished {source_path.split("/")[-1]} in {int(time.time() - start_time)}s")
    print("")
